물리를 적용한 간단한 퍼즐 쌓기 게임인 "차곡차곡 서커스"의 [LG 스마트 TV용 앱](http://kr.lgappstv.com/appspc/store/product/retrieveProductInfo.lge?appId=166218)이 발매되었다. 스마트 TV앱까지 개발할지는 몰랐는데 알다가도 모를 일이다.

스마트 TV 앱 개발은 iOS나 안드로이드 앱 개발과는 다르게 관련 자료가 많지 않으니 개발하면서 얻은 경험을 간단하게 정리한다.

## 마멀레이드(Marmalade)와 COCOS2D-X 조합

[마멀레이드 SDK](http://www.madewithmarmalade.com/)는 크로스 플랫폼 앱 개발환경으로 LG 스마트 TV를 공식 지원하고 있다. LG 스마트 TV에 빌드해서 올리려면 LG측에서 관련 도구도 받아야 한다 (아마도 계약하면 주는 것 같은데, 이건 내가 진행한건 아닌지라 잘 모른다). TV에 올리는 과정이 좀 번거로우니 물론 시뮬레이터가 준비되어 있다.

COCOS2D-X는 아이폰용 2D 게임 개발 엔진으로 유명한 COCOS2D를 C++로 포팅해서 아이폰 외에도 안드로이드 환경도 지원하는 게임 엔진이다. 마멀레이드 SDK위에 COCOS2D-X를 올려서 이미 검증된 API와 사용법과 도구를 이용해서 마멀레이드 위에서 게임을 만들 수 있다.

마멀레이드의 웹 사이트 설명이 그리 친절하지 않고, 초기와 현재는 연동 방식과 지원 방식도 꽤 변한 것으로 보인다. 인터넷 자료는 오래된 자료를 가리키는 경우가 많기에 헷갈릴 수 있지만 이제는 COCOS2D-X의 공식 배포판만 다운로드 받으면 된다. COCOS2D-X의 배포판안에 마멀레이드용 프로젝트를 생성할 수 있도록 관련 내용이 포함되어 있고, 마멀레이드 SDK의 설치 경로를 알아서 찾아서 빌드되고, 마멀레이드 시뮬레이터 위에서 실행된다.

HOW-TO 문서를 만들 의도가 아니니 개발하면서 겪었던 상황을 몇가지 정리한다.

1. 생성된 Xcode 프로젝트 껍데기 코드가 온통 절대 경로로 박혀 있다. 번거롭다.
2. COCOS2D-X는 모바일 개발 플랫폼이기에 마우스 오버 등의 이벤트 처리가 불가능하다. 마멀레이드의 저수준 API를 이용하면 된다. 예를 들어, 커서가 버튼 위에 있을 때 표시해주고, 버튼을 벗어나면 다시 원상태로 돌려두려고 한다면 기본 COCOS2D-X의 터치 이벤트로는 처리할 수 없다.
3. 마찬가지로 하드위어 센서도 마멀레이드의 저수준 API를 이용한다. 마멀레이드 SDK 설치 경로에 관련 예제가 있다.
4. 마멀레이드 API에서 LG TV 리모콘의 움직임은 마우스 커서로, 휠과 휠 버튼은 마우스 휠과 마우스 버튼으로 인식된다. 그외에 뒤로가기 버튼 등은 키보드 이벤트로 인식된다.
5. COCOS2D-X는 Objective-C의 레퍼런스 카운팅 기법을 빌려왔다. ARC 이전의 아이폰 앱 개발 경험이 있다면 메모리 관리는 크게 걱정할 필요는 없다. 물론 COCOS2D-X의 밖에서 사용하는 모든 것은 관리해줘야 한다.
6. 스마트 TV 리모콘의 회전값을 이용하려면 가속도계의 값을 활용할 수 있다. 꽤 정확한 편이다.
7. LG에서 제공하는 빌드 도구는 예상대로 윈도만 지원한다.
8. AppCode에서 Xcode 프로젝트를 열면 빌드까지는 되는데, 실행과 관련된 정보를 제대로 불러오지 못한다. 디버그가 필요한 경우에는 Xcode에서 확인했고 그 외에는 마멀레이드 시뮬레이터를 실행하는 스크립트를 하나 짜서 AppCode에 External Tool로 등록해서 사용했다.
9. 생각보단 하드웨어 성능이 잘 나온다. 2013년형 모델을 배포 대상으로 개발하고 테스트 했기에 이전 모델의 성능은 잘 모르겠지만, 스마트 TV의 전체적으로 느린 UI 반응 속도 때문에 겁 먹었는데 생각만큼 느리지는 않았다. (만든 게임 자체가 크게 리소스를 사용하지는 않는다는 사실도 잊지는 말자.)

## 참고: 마멀레이드 퀵(Marmalade Quick)은 쳐다보지 말자

마멀레이드에서 공식 제공하고 있는 마멀레이드 퀵은 "마멀레이드 + COCO2D-X"위에 추상화 레이어를 씌워 루아(Lua)로 바인딩해둔 개발 환경이다. 루아로 개발할 수 있으니 메모리 관리나, 컴파일 같은 복잡하고 번거로운 과정이 없어서 좋다 (잘 해놨다면). 근데 API를 엉망으로 추상화해두어서 좋은건 여기까지이다. 마멀레이드 퀵을 포기하게 만든 몇가지 아주 심각한 상황을 보자. (전체적인 구조 자체가 문제라고 생각 중이다.)

1. 아틀라스(atlas)로부터 스프라이트(sprite)를 바로 생성하는 방법이 없다. 필요도 없는 애니메이션 객체를 거쳐야 한다. "아틀라스 > 애니메이션 > 스프라이트"의 순서대로 생성해야 한다.
2. Box2D는 기본적으로 Shape당 최대 8개의 Vertex를 가질 수 있다. 자세한 형태의 물리 모형을 따려면 하나의 물리 Body가 여러 개의 Shape을 가지는 구조로 만든다. 그런데 마멀레이드 퀵은 Body당 Shape이 1:1로 매핑이 되어 있다. 사각형, 삼각형, 원만을 샘플로 만들어본 것이 아니라면 절대로 나올 수 없는 구조이다.
3. 씬 관리가 형편 없다. 예제 코드부터 라이프 사이클이 엉망이다. 자세한 설명은 생략. 
4. 메모리 관리가 제대로 되고 있는지 의문. 공식 문서에서 시키는대로 따라해도 미심쩍은 상황이 계속된다.

있는 그대로의 COCOS2D-X 코드를 바인딩해두었다면 좋았으련만 아쉽다. (이건 또 COCOS2D-X쪽에서 작업한 프로젝트가 있는 것 같은데 찾아보지 않았다.)

##  그러니까

처음 스마트 TV용 게임을 만든다고 들었을 때 (초기의 바다 SDK 같이) 문서화도 형편없고 일관성도 없이 자주 변하는 자체 플랫폼을 배워야 하는 것은 아닐지 걱정했었다. 이미 검증된 게임 엔진인 COCOS2D-X가 동작한다니 얼마나 다행인지. (항상 새로운 것을 시작해야 한다는건 두렵다. 사실 COCOS2D-X도 C++ 언어를 사용해야 하기에 꽤 부담감을 느꼈다.)

LG 전자에서 가전에 넣기 위해서 Web OS를 인수하였기에 앞으로의 개발 환경이 어떻게 변할지는 알 수는 없지만, 당장 LG 스마트 TV용 게임을 개발해야 한다면 마멀레이드와 COCOS2D-X의 조합이 가장 좋은 선택으로 보인다.

생각보다 COCOS2D-X만 배우면 기술적으로는 나머지는 크게 부담 없이 개발이 가능하고, 하드웨어 성능도 꽤 잘 나오는 편이라 만족스럽다. 하드웨어 센서를 테스트 하는 환경은 그리 아름답지 못하지만 이건 엄청나게 많은 앱들이 개발되고 있는 스마트폰 쪽에서도 그리 잘 풀어내고 있는 것 같지는 않다 (이제는 안드로이드 에뮬레이터에서 멀티터치는 되는지?). 

온 가족이 둘러 앉아서 간단하게 즐길 수 있는 콘텐츠가 많이 나오면 좋을 것 같다. (이를테면, iOS용 [King of Opera](https://itunes.apple.com/kr/app/king-opera-multiplayer-party/id408697793?mt=8) 같은 게임)

* * *

[[게임개발]], [[블로그글]]
